<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous" />
        <script src="Scripts/jquery-3.3.1.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script src="Scripts/knockout-3.4.2.js"></script>
        <script>
            var url = 'rest/calculadora/';
            
            var sendRequest = function (url, verb, data) {
                var settings = {
                    url: url,
                    method: verb,
                    "headers": {
                      "Content-Type" : "application/json"
                    },
                    data : JSON.stringify(data)
                  }
                return $.ajax(settings); 
            }
            
            var model =  {
                    categorias :  ko.observable([]),
                    nombre : ko.observable(""),
                    valor : ko.observable(""),
                    categoria : ko.observable("")
                }
            
            var total = ko.computed(function() {
                let cat = model.categoria();
                let val = model.valor();
                if(cat)
                    return val * (1 + cat.Valor);
                else
                    return 0
            })
            
            var impuesto = ko.computed(function() {
                let cat = model.categoria();
                let val = model.valor();
                if(cat)
                    return val * cat.Valor;
                else
                    return 0
            })
            
            function notificar(){
                $(".alert").toggleClass('in out'); 
                return false; // Keep close.bs.alert event from removing from DOM
            }
            
            var guardar = function() {
                let data = {
                    nombre : model.nombre(),
                    valor: model.valor(),
                    categoria: model.categoria().Nombre
                }
                console.log(data);
                /*sendRequest(url,'POST',data)
                        .done(()=>{
                            notificar();
                        }).fail((e)=>{
                            console.log(e);
                        })*/
            }
            
            $(function(){
                ko.applyBindings();
                $('#bsalert').on('close.bs.alert', notificar)
                sendRequest(url,'GET')
                        .done((d)=>{
                            model.categorias(d);
                        })
                        .fail((d)=> {console.log(d)})
            })
        </script>
    </head>
    <body>
        <br>
        <div class="col-sm-2"></div>
        <div class="col-sm-8">
        <div class="panel panel-primary">
            <div class="panel-heading">
                Calculadora
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label for="nombre">Nombre Producto: </label>
                    <input type="text" data-bind="textInput: model.nombre" id="nombre" class="form-control"></input>
                </div>
                <div class="form-group">
                    <label for="valor">Valor:</label>
                    <input type="number" data-bind="textInput: model.valor" class="form-control" id="valor">
                </div>
                <div class="form-group">
                    <label for="categoria">Categoria</label>
                    <select name="categoria" data-bind="options: model.categorias, optionsText: 'Nombre', value: model.categoria" class="form-control" id="categoria"></select>
                </div>
                <div class="form-group">
                    <label for="impuesto">Impuesto calculado: </label>
                    <input type="text" data-bind="value: impuesto() + ' $'" disabled="disabled" class="form-control" name="impuesto" id="impuesto">
                </div>
                <div class="form-group">
                    <label for="total">Total: </label> 
                    <input type="text" data-bind="value: total() + ' $'" disabled="disabled" class="form-control" width="20px" name="total" id="total">
                </div>
                <div class="form-group">
                    <button type="button" data-bind="click: guardar" class="btn btn-primary">Guardar</button>
                </div>
            </div>
            <div class="alert alert-success fade out" id="bsalert">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                <strong>Registro almacenado!</strong> 
            </div>
        </div>
        <div class="col-sm-2"></div>
    </body>
</html>
